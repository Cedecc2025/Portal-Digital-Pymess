<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema PyME - Mi Negocio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
            --whatsapp: #25d366;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gradient-1);
            min-height: 100vh;
            padding: 20px;
        }

        body.admin-mode {
            background: var(--gradient-2);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Header */
        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-img {
            height: 40px;
            border-radius: 5px;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-header {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-header:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .btn-header.active {
            background: white;
            color: var(--primary);
        }

        .btn-header.whatsapp-btn {
            background: var(--whatsapp);
        }

        .btn-header.whatsapp-btn:hover {
            background: #1ba855;
            transform: scale(1.05);
        }

        .cart-badge {
            background: var(--danger);
            color: white;
            border-radius: 50%;
            padding: 2px 8px;
            font-size: 12px;
            margin-left: 5px;
            display: none;
        }

        .cart-badge.show {
            display: inline-block;
        }

        /* Admin Lock Button */
        .admin-lock {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--dark);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
            font-size: 20px;
        }

        .admin-lock:hover {
            transform: scale(1.1);
            background: var(--primary);
        }

        .admin-lock.unlocked {
            background: var(--success);
        }

        /* Admin Banner */
        .admin-banner {
            background: var(--gradient-2);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        body.admin-mode .admin-banner {
            display: block;
        }

        /* Admin Only Elements */
        .admin-only {
            display: none !important;
        }

        body.admin-mode .admin-only {
            display: inline-block !important;
        }

        body.admin-mode .admin-inline {
            display: inline-block !important;
        }

        body.admin-mode .admin-flex {
            display: flex !important;
        }

        body.admin-mode .admin-block {
            display: block !important;
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: var(--light);
            padding: 10px 20px;
            display: none;
            gap: 10px;
            overflow-x: auto;
        }

        body.admin-mode .nav-tabs {
            display: flex;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: var(--primary);
            color: white;
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Sections */
        .section {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }

        .section.active {
            display: block;
        }

        /* Search and Filter */
        .controls {
            padding: 20px;
            background: var(--light);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Products Grid */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .product-card {
            background: white;
            border: 2px solid var(--border);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .product-card:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .product-image {
            width: 100%;
            height: 180px;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
            background-size: cover;
            background-position: center;
        }

        .product-image.has-image {
            font-size: 0;
        }

        .product-info {
            padding: 15px;
        }

        .product-category {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .product-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .product-description {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 10px;
            line-height: 1.4;
            height: 35px;
            overflow: hidden;
        }

        .product-price {
            font-size: 20px;
            color: var(--primary);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-stock {
            display: inline-block;
            padding: 4px 8px;
            background: var(--success);
            color: white;
            border-radius: 5px;
            font-size: 11px;
        }

        .product-stock.low {
            background: var(--warning);
        }

        .product-stock.out {
            background: var(--danger);
        }

        .product-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-add-cart {
            flex: 1;
            background: var(--success);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-add-cart:hover {
            background: #059669;
        }

        .btn-add-cart:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn-edit {
            background: var(--warning);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .btn-delete {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--dark);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: var(--dark);
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        /* WhatsApp Processor Section */
        .whatsapp-processor {
            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
        }

        .whatsapp-processor h3 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .whatsapp-input-area {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .whatsapp-textarea {
            width: 100%;
            min-height: 150px;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        .whatsapp-textarea:focus {
            outline: none;
            border-color: var(--whatsapp);
            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.2);
        }

        .parsed-data {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
            color: var(--dark);
            display: none;
        }

        .parsed-data.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .parsed-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        .parsed-item:last-child {
            border-bottom: none;
        }

        .parsed-label {
            font-weight: bold;
            color: var(--dark);
        }

        .parsed-value {
            color: #6b7280;
        }

        .parsed-products {
            background: var(--light);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .parsed-product-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
        }

        .btn-process {
            background: white;
            color: var(--whatsapp);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-process:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-process:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .process-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
            animation: slideIn 0.3s;
        }

        .process-status.success {
            background: var(--success);
            color: white;
        }

        .process-status.error {
            background: var(--danger);
            color: white;
        }

        .process-status.warning {
            background: var(--warning);
            color: white;
        }

        /* Cart */
        .cart-items {
            background: var(--light);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .cart-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: var(--primary);
            font-size: 14px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .quantity-btn:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quantity-display {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .btn-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .cart-total {
            background: var(--dark);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .total-row.final {
            font-size: 20px;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid rgba(255,255,255,0.2);
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--gradient-1);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--primary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--light);
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-whatsapp {
            background: var(--whatsapp);
        }

        .btn-whatsapp:hover {
            background: #1ba855;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-warning {
            background: var(--warning);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            animation: slideInRight 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .notification.success {
            background: var(--success);
        }

        .notification.warning {
            background: var(--warning);
        }

        .notification.error {
            background: var(--danger);
        }

        .notification.info {
            background: var(--primary);
        }

        /* Notification Center */
        #notificationBtn {
            position: relative;
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .notification-dropdown {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 400px;
            max-height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            z-index: 2500;
            overflow: hidden;
        }

        .notification-dropdown.show {
            display: block;
            animation: slideIn 0.3s;
        }

        .notification-dropdown-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-dropdown-title {
            font-weight: bold;
            font-size: 16px;
        }

        .clear-notifications-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .clear-notifications-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .notification-list {
            max-height: 420px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-item:hover {
            background: var(--light);
        }

        .notification-item.unread {
            background: #f0f9ff;
            border-left: 4px solid var(--primary);
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .notification-item-title {
            font-weight: bold;
            color: var(--dark);
            font-size: 14px;
        }

        .notification-item-time {
            font-size: 11px;
            color: #6b7280;
        }

        .notification-item-content {
            color: #4b5563;
            font-size: 13px;
            line-height: 1.5;
        }

        .notification-item-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        .notification-action-btn {
            padding: 5px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .notification-action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .notification-action-btn.primary:hover {
            background: #1d4ed8;
        }

        .notification-action-btn.secondary {
            background: var(--light);
            color: var(--dark);
        }

        .notification-action-btn.secondary:hover {
            background: #e5e7eb;
        }

        .notification-empty {
            padding: 40px;
            text-align: center;
            color: #6b7280;
        }

        .notification-settings {
            padding: 15px 20px;
            background: var(--light);
            border-top: 1px solid var(--border);
        }

        .notification-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-toggle input[type="checkbox"] {
            width: 40px;
            height: 20px;
            appearance: none;
            background: #cbd5e1;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }

        .notification-toggle input[type="checkbox"]:checked {
            background: var(--success);
        }

        .notification-toggle input[type="checkbox"]::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .notification-toggle input[type="checkbox"]:checked::after {
            transform: translateX(20px);
        }

        /* Purchase Popup */
        .purchase-popup {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            z-index: 3500;
            min-width: 350px;
            border-left: 5px solid var(--success);
        }

        .purchase-popup.show {
            display: block;
            animation: slideIn 0.5s;
        }

        .purchase-popup-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .purchase-popup-icon {
            width: 50px;
            height: 50px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: pulse 1s;
        }

        .purchase-popup-content h3 {
            margin-bottom: 5px;
            color: var(--dark);
        }

        .purchase-popup-details {
            color: #6b7280;
            font-size: 14px;
        }

        /* Image Upload */
        .image-upload-section {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background: var(--light);
        }

        .image-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            margin: 10px auto;
            border-radius: 10px;
            object-fit: cover;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        /* Color Picker Section */
        .color-picker-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .color-input {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        /* Chatbot Widget */
        .chatbot-widget {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 999;
        }

        .chatbot-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-button:hover {
            transform: scale(1.1);
            background: #1d4ed8;
        }

        .chatbot-button .notification-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
            display: none;
        }

        .chatbot-window {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        .chatbot-window.show {
            display: flex;
        }

        .chatbot-header {
            background: var(--primary);
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chatbot-status {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            display: inline-block;
        }

        .chatbot-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f9f9f9;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        .chat-message.bot {
            text-align: left;
        }

        .chat-message.user {
            text-align: right;
        }

        .message-bubble {
            display: inline-block;
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 14px;
            line-height: 1.4;
        }

        .bot .message-bubble {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }

        .user .message-bubble {
            background: var(--primary);
            color: white;
        }

        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chatbot-typing {
            display: none;
            padding: 10px 15px;
            background: white;
            border-radius: 15px;
            border: 1px solid var(--border);
            width: fit-content;
            margin: 0 15px;
        }

        .chatbot-typing.show {
            display: inline-block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .chatbot-options {
            padding: 10px;
            background: white;
            border-top: 1px solid var(--border);
        }

        .chat-option-btn {
            display: block;
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .chat-option-btn:hover {
            background: var(--primary);
            color: white;
        }

        .chatbot-input {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--border);
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
        }

        .chat-send {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .chat-send:hover {
            background: #1d4ed8;
            transform: scale(1.1);
        }

        /* FAQ Item */
        .faq-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }

        .faq-item input, .faq-item textarea {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chatbot-window {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }

            .notification-dropdown {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
        }

        /* Product match indicator */
        .product-match {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 11px;
        }

        .product-match.found {
            background: var(--success);
            color: white;
        }

        .product-match.not-found {
            background: var(--warning);
            color: white;
        }

        .product-match.created {
            background: var(--primary);
            color: white;
        }

        /* Tooltip */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Banner -->
        <div class="admin-banner">
            üîê MODO ADMINISTRADOR ACTIVO
        </div>

        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <span class="logo">
                    <img id="businessLogo" src="" alt="" class="logo-img" style="display: none;">
                    <span id="logoIcon">üè™</span>
                    <span id="businessName">Mi Negocio</span>
                </span>
            </div>
            <div class="header-buttons">
                <button class="btn-header" onclick="openCart()">
                    üõí Carrito <span class="cart-badge" id="cartBadge">0</span>
                </button>
                <button class="btn-header whatsapp-btn admin-only" id="whatsappProcessBtn" onclick="showModal('whatsappProcessModal')">
                    üì± Procesar WhatsApp
                </button>
                <button class="btn-header" id="notificationBtn" onclick="toggleNotificationCenter()" style="display: none; position: relative;">
                    üîî Notificaciones
                    <span class="notification-count" id="notificationCount" style="display: none;">0</span>
                </button>
                <button class="btn-header" id="addProductBtn" onclick="showModal('productModal')" style="display: none;">
                    ‚ûï Producto
                </button>
                <button class="btn-header" id="logoutBtn" onclick="logout()" style="display: none;">
                    üö™ Salir Admin
                </button>
            </div>
        </header>

        <!-- Navigation Tabs (Admin Only) -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('catalog', this)">üì¶ Cat√°logo</button>
            <button class="nav-tab" onclick="showSection('dashboard', this)">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('sales', this)">üí∞ Ventas</button>
            <button class="nav-tab" onclick="showSection('clients', this)">üë• Clientes</button>
            <button class="nav-tab" onclick="showSection('inventory', this)">üìã Inventario</button>
            <button class="nav-tab" onclick="showSection('chatbot', this)">ü§ñ Chatbot</button>
            <button class="nav-tab" onclick="showSection('settings', this)">‚öôÔ∏è Config</button>
        </div>

        <!-- Catalog Section (Always Visible) -->
        <section id="catalog" class="section active">
            <div class="controls">
                <div class="search-box">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar productos...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterCategory('all', this)">Todos</button>
                    <button class="filter-btn" onclick="filterCategory('Alimentos', this)">Alimentos</button>
                    <button class="filter-btn" onclick="filterCategory('Bebidas', this)">Bebidas</button>
                    <button class="filter-btn" onclick="filterCategory('Tecnolog√≠a', this)">Tecnolog√≠a</button>
                    <button class="filter-btn" onclick="filterCategory('Hogar', this)">Hogar</button>
                    <button class="filter-btn" onclick="filterCategory('Ropa', this)">Ropa</button>
                    <button class="filter-btn" onclick="filterCategory('Otros', this)">Otros</button>
                </div>
            </div>
            
            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </section>

        <!-- Dashboard Section (Admin Only) -->
        <section id="dashboard" class="section">
            <h2 style="margin-bottom: 30px;">Panel de Control</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSales">‚Ç°0</div>
                    <div class="stat-label">Ventas Totales</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-2);">
                    <div class="stat-value" id="totalClients">0</div>
                    <div class="stat-label">Clientes</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-3);">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Productos</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-4);">
                    <div class="stat-value" id="todayOrders">0</div>
                    <div class="stat-label">Pedidos Hoy</div>
                </div>
            </div>

            <h3 style="margin: 30px 0 20px;">√öltimas Ventas</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="recentSalesTable">
                        <tr><td colspan="4" style="text-align: center;">No hay ventas</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Sales Section (Admin Only) -->
        <section id="sales" class="section">
            <!-- WhatsApp Processor Section -->
            <div class="whatsapp-processor">
                <h3>
                    üì± Procesador de Pedidos WhatsApp
                    <span class="tooltip" style="margin-left: 10px; font-size: 18px;">
                        ‚ÑπÔ∏è
                        <span class="tooltiptext">Pega aqu√≠ los mensajes de pedidos que recibes por WhatsApp para procesarlos autom√°ticamente</span>
                    </span>
                </h3>
                
                <div class="whatsapp-input-area">
                    <textarea 
                        class="whatsapp-textarea" 
                        id="whatsappMessageInput"
                        placeholder="Pega aqu√≠ el mensaje de WhatsApp...

Ejemplo:
üõçÔ∏è NUEVO PEDIDO

Cliente: Yuli
Tel√©fono: 50687592588

üì¶ Productos:
‚Ä¢ Camisa x1 = ‚Ç°2000

Subtotal: ‚Ç°2000
IVA (13%): ‚Ç°260
TOTAL: ‚Ç°2260"
                    ></textarea>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-process" onclick="parseWhatsAppMessage()">
                        üîç Analizar Mensaje
                    </button>
                    <button class="btn-process" onclick="clearWhatsAppProcessor()" style="background: var(--danger); color: white;">
                        üóëÔ∏è Limpiar
                    </button>
                </div>
                
                <div class="parsed-data" id="parsedData">
                    <!-- Parsed data will appear here -->
                </div>
                
                <div class="process-status" id="processStatus">
                    <!-- Status messages will appear here -->
                </div>
            </div>

            <h2 style="margin: 30px 0;">Historial de Ventas</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="salesTable">
                        <tr><td colspan="6" style="text-align: center;">No hay ventas</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Clients Section (Admin Only) -->
        <section id="clients" class="section">
            <h2 style="margin-bottom: 30px;">Gesti√≥n de Clientes</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Direcci√≥n</th>
                            <th>Compras</th>
                            <th>Total Gastado</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTable">
                        <tr><td colspan="5" style="text-align: center;">No hay clientes</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Inventory Section (Admin Only) -->
        <section id="inventory" class="section">
            <h2 style="margin-bottom: 30px;">Control de Inventario</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categor√≠a</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable">
                        <tr><td colspan="5" style="text-align: center;">No hay productos</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Chatbot Section (Admin Only) -->
        <section id="chatbot" class="section">
            <h2 style="margin-bottom: 30px;">Configuraci√≥n del Chatbot</h2>
            
            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Configuraci√≥n General</h3>
                <div class="form-group">
                    <label class="form-label">Nombre del Asistente</label>
                    <input type="text" class="form-input" id="botName" placeholder="Ej: Asistente Virtual">
                </div>
                <div class="form-group">
                    <label class="form-label">Mensaje de Bienvenida</label>
                    <textarea class="form-textarea" id="botWelcome" placeholder="¬°Hola! Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="botEnabled" checked> Chatbot Activado
                    </label>
                </div>
                <button class="btn-primary" onclick="saveChatbotSettings()">Guardar Configuraci√≥n</button>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Preguntas Frecuentes (FAQ)</h3>
                <div id="faqList" style="margin-bottom: 20px;">
                    <!-- FAQ items will be loaded here -->
                </div>
                <button class="btn-primary" onclick="addFAQ()">‚ûï Agregar Pregunta</button>
            </div>

            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px;">Respuestas R√°pidas</h3>
                <div class="form-group">
                    <label class="form-label">Horario de Atenci√≥n</label>
                    <input type="text" class="form-input" id="botHours" placeholder="Lunes a Viernes: 8am - 6pm">
                </div>
                <div class="form-group">
                    <label class="form-label">Tiempo de Entrega</label>
                    <input type="text" class="form-input" id="botDelivery" placeholder="24-48 horas en el GAM">
                </div>
                <div class="form-group">
                    <label class="form-label">M√©todos de Pago</label>
                    <input type="text" class="form-input" id="botPayment" placeholder="Efectivo, SINPE, Transferencia">
                </div>
                <button class="btn-primary" onclick="saveQuickResponses()">Guardar Respuestas</button>
            </div>
        </section>

        <!-- Settings Section (Admin Only) -->
        <section id="settings" class="section">
            <h2 style="margin-bottom: 30px;">Configuraci√≥n</h2>
            
            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Informaci√≥n del Negocio</h3>
                <div class="form-group">
                    <label class="form-label">Nombre del Negocio</label>
                    <input type="text" class="form-input" id="settingsBusinessName" placeholder="Mi Negocio">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Logo del Negocio</label>
                    <input type="url" class="form-input" id="settingsLogoUrl" placeholder="https://ejemplo.com/logo.png" style="margin-bottom: 10px;">
                    <input type="file" id="logoFileInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                    <button type="button" class="btn-primary" onclick="document.getElementById('logoFileInput').click()">
                        üì∑ Subir Logo
                    </button>
                    <button type="button" class="btn-primary btn-danger" onclick="removeLogo()" id="removeLogoBtn" style="margin-left: 10px; display: none;">
                        üóëÔ∏è Quitar Logo
                    </button>
                    <div id="logoPreview" style="margin-top: 15px;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">WhatsApp (incluir c√≥digo de pa√≠s)</label>
                    <input type="text" class="form-input" id="settingsWhatsApp" placeholder="50688888888">
                </div>
                <div class="form-group">
                    <label class="form-label">Correo Electr√≥nico</label>
                    <input type="email" class="form-input" id="settingsEmail" placeholder="correo@ejemplo.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a Admin</label>
                    <input type="password" class="form-input" id="settingsPassword" placeholder="Nueva contrase√±a">
                </div>
                <button class="btn-primary" onclick="saveSettings()">Guardar Configuraci√≥n</button>
            </div>
            
            <div style="background: var(--light); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 20px;">Personalizaci√≥n de Colores</h3>
                <div class="color-picker-group">
                    <label style="width: 150px;">Color Principal:</label>
                    <input type="color" id="primaryColor" class="color-input" value="#2563eb">
                    <input type="text" class="form-input" id="primaryColorHex" value="#2563eb" style="width: 100px;" onchange="updateColorFromHex('primary')">
                </div>
                <div class="color-picker-group">
                    <label style="width: 150px;">Fondo degradado:</label>
                    <input type="color" id="bgColor1" class="color-input" value="#667eea">
                    <span>hasta</span>
                    <input type="color" id="bgColor2" class="color-input" value="#764ba2">
                </div>
                <button class="btn-primary" onclick="saveColors()">Aplicar Colores</button>
                <button class="btn-primary btn-warning" onclick="resetColors()" style="margin-left: 10px;">üîÑ Restaurar Colores</button>
            </div>
            
            <div style="background: var(--light); padding: 25px; border-radius: 15px;">
                <h3 style="margin-bottom: 20px;">Backup y Restauraci√≥n</h3>
                <button class="btn-primary" onclick="exportData()">üíæ Exportar Datos</button>
                <button class="btn-primary btn-warning" onclick="importData()" style="margin-left: 10px;">üìÇ Importar</button>
                <button class="btn-primary btn-danger" onclick="factoryReset()" style="margin-left: 10px;">üè≠ Reinicio Total</button>
            </div>
        </section>
    </div>

    <!-- Admin Lock Button -->
    <div class="admin-lock" id="adminLock" onclick="showAdminLogin()">
        üîí
    </div>

    <!-- Notification Dropdown -->
    <div class="notification-dropdown" id="notificationDropdown">
        <div class="notification-dropdown-header">
            <span class="notification-dropdown-title">üì¨ Centro de Notificaciones</span>
            <button class="clear-notifications-btn" onclick="clearAllNotifications()">Limpiar todo</button>
        </div>
        <div class="notification-list" id="notificationList">
            <div class="notification-empty">
                <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                <p>No hay notificaciones nuevas</p>
            </div>
        </div>
        <div class="notification-settings">
            <label class="notification-toggle">
                <input type="checkbox" id="notificationSound" checked>
                <span style="font-size: 14px;">üîä Sonido de notificaciones</span>
            </label>
            <label class="notification-toggle" style="margin-top: 10px;">
                <input type="checkbox" id="browserNotifications" onclick="toggleBrowserNotifications()">
                <span style="font-size: 14px;">üåê Notificaciones del navegador</span>
            </label>
        </div>
    </div>

    <!-- Purchase Popup -->
    <div class="purchase-popup" id="purchasePopup">
        <button style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;" onclick="closePurchasePopup()">√ó</button>
        <div class="purchase-popup-header">
            <div class="purchase-popup-icon">üõçÔ∏è</div>
            <div class="purchase-popup-content">
                <h3>¬°Nueva Compra Recibida!</h3>
                <div class="purchase-popup-details" id="purchaseDetails">
                    <!-- Details will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot Widget -->
    <div class="chatbot-widget" id="chatbotWidget" style="display: none;">
        <button class="chatbot-button" onclick="toggleChatbot()">
            üí¨
            <span class="notification-dot"></span>
        </button>
        
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <h3>
                    <span class="chatbot-status"></span>
                    <span id="chatbotTitle">Asistente Virtual</span>
                </h3>
                <button class="chatbot-close" onclick="toggleChatbot()">&times;</button>
            </div>
            
            <div class="chatbot-messages" id="chatMessages">
                <!-- Messages will appear here -->
            </div>
            
            <div class="chatbot-typing" id="typingIndicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="chatbot-options" id="chatOptions">
                <button class="chat-option-btn" onclick="sendQuickMessage('horario')">üïê Horario de atenci√≥n</button>
                <button class="chat-option-btn" onclick="sendQuickMessage('entrega')">üöö Tiempos de entrega</button>
                <button class="chat-option-btn" onclick="sendQuickMessage('pago')">üí≥ M√©todos de pago</button>
                <button class="chat-option-btn" onclick="sendQuickMessage('contacto')">üìû Contactar vendedor</button>
            </div>
            
            <div class="chatbot-input">
                <input type="text" class="chat-input" id="chatInput" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Process Modal -->
    <div class="modal" id="whatsappProcessModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì± Procesar Pedido de WhatsApp</h2>
                <button class="close-modal" onclick="closeModal('whatsappProcessModal')">&times;</button>
            </div>
            
            <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <p style="font-size: 14px; color: #6b7280;">
                    üí° <strong>Instrucciones:</strong> Copia y pega el mensaje completo del pedido que recibiste por WhatsApp. 
                    El sistema detectar√° autom√°ticamente el cliente, productos y totales.
                </p>
            </div>
            
            <textarea 
                class="form-textarea" 
                id="modalWhatsappInput"
                style="min-height: 200px; font-family: 'Courier New', monospace;"
                placeholder="Pega aqu√≠ el mensaje de WhatsApp..."
            ></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-primary" onclick="processWhatsAppFromModal()">
                    üîç Procesar Pedido
                </button>
                <button class="btn-primary btn-danger" onclick="closeModal('whatsappProcessModal')">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div class="modal" id="cartModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üõí Carrito de Compras</h2>
                <button class="close-modal" onclick="closeModal('cartModal')">&times;</button>
            </div>

            <div class="cart-items" id="cartItems">
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p>Tu carrito est√° vac√≠o</p>
                </div>
            </div>

            <div id="clientForm" style="display: none;">
                <h3 style="margin: 20px 0 15px;">Informaci√≥n de Contacto</h3>
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-input" id="clientName">
                    <div class="error-message" id="nameError">Campo obligatorio</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tel√©fono *</label>
                    <input type="tel" class="form-input" id="clientPhone" placeholder="88888888">
                    <div class="error-message" id="phoneError">Campo obligatorio</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Direcci√≥n</label>
                    <textarea class="form-textarea" id="clientAddress" placeholder="Direcci√≥n de entrega"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Notas del Pedido</label>
                    <textarea class="form-textarea" id="clientNotes" placeholder="Instrucciones especiales, horario de entrega, etc."></textarea>
                </div>
            </div>

            <div class="cart-total" id="cartTotal" style="display: none;">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">‚Ç°0</span>
                </div>
                <div class="total-row">
                    <span>IVA (13%):</span>
                    <span id="tax">‚Ç°0</span>
                </div>
                <div class="total-row final">
                    <span>Total:</span>
                    <span id="total">‚Ç°0</span>
                </div>
                <button class="btn-primary btn-whatsapp" id="sendWhatsAppBtn" onclick="sendWhatsApp()" style="width: 100%; margin-top: 15px;">
                    üì± Enviar Pedido por WhatsApp
                </button>
                <p id="orderInfo" style="margin-top: 10px; text-align: center; color: white; font-size: 12px; opacity: 0.8;">
                    Al enviar, se actualizar√° el inventario y se registrar√° la venta
                </p>
            </div>
        </div>
    </div>

    <!-- Product Modal (Admin) -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="productModalTitle">Agregar Producto</h2>
                <button class="close-modal" onclick="closeModal('productModal')">&times;</button>
            </div>
            
            <form onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="image-upload-section">
                    <h4>Imagen del Producto</h4>
                    <img id="imagePreview" class="image-preview">
                    <input type="file" id="productImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <button type="button" class="btn-primary" onclick="document.getElementById('productImageFile').click()">
                        üì∑ Seleccionar Imagen
                    </button>
                    <input type="url" class="form-input" id="productImageUrl" placeholder="O pega URL de imagen" style="margin-top: 10px;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="text" class="form-input" id="productName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <select class="form-select" id="productCategory" required>
                        <option value="">Seleccionar...</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Tecnolog√≠a">Tecnolog√≠a</option>
                        <option value="Hogar">Hogar</option>
                        <option value="Ropa">Ropa</option>
                        <option value="Salud">Salud</option>
                        <option value="Otros">Otros</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-textarea" id="productDescription"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Precio *</label>
                    <input type="number" class="form-input" id="productPrice" required min="0">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stock *</label>
                    <input type="number" class="form-input" id="productStock" required min="0">
                </div>
                
                <button type="submit" class="btn-primary" style="width: 100%;">
                    Guardar Producto
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal" id="adminModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üîê Acceso Administrativo</h2>
                <button class="close-modal" onclick="closeModal('adminModal')">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" class="form-input" id="adminPassword" placeholder="Ingresa la contrase√±a" onkeypress="if(event.key==='Enter') login()">
            </div>
            
            <button class="btn-primary" onclick="login()" style="width: 100%;">
                Ingresar
            </button>
            
            <p style="margin-top: 15px; text-align: center; color: #6b7280; font-size: 14px;">
                Contrase√±a por defecto: admin123
            </p>
        </div>
    </div>

    <script>
        // App State
        let appData = {
            settings: {
                businessName: 'Mi Negocio',
                whatsapp: '',
                email: '',
                password: 'admin123',
                logo: '',
                colors: {
                    primary: '#2563eb',
                    bgColor1: '#667eea',
                    bgColor2: '#764ba2'
                },
                notifications: {
                    sound: true,
                    browser: false
                }
            },
            chatbot: {
                enabled: true,
                name: 'Asistente Virtual',
                welcome: '¬°Hola! üëã Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?',
                faqs: [],
                quickResponses: {
                    horario: 'Nuestro horario de atenci√≥n es de Lunes a Viernes.',
                    entrega: 'Los tiempos de entrega son de 24-48 horas.',
                    pago: 'Aceptamos: Efectivo, SINPE M√≥vil, Transferencia.',
                    contacto: ''
                }
            },
            products: [],
            clients: [],
            sales: [],
            cart: [],
            notifications: []
        };

        let isAdmin = false;
        let currentFilter = 'all';
        let editingProductId = null;
        let lastSaleData = null;
        let parsedWhatsAppData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if it's first time setup
            if (!localStorage.getItem('pymeSystemInitialized')) {
                // First time - start completely fresh
                localStorage.setItem('pymeSystemInitialized', 'true');
                saveData();
                showNotification('üéâ Sistema listo - Configura tu negocio en ‚öôÔ∏è Config', 'info');
            } else {
                // Load existing data
                loadData();
            }
            
            loadProducts();
            updateCartBadge();
            initializeChatbot();
            updateNotificationBadge();
            
            // Show welcome message if no products
            if (appData.products.length === 0 && !sessionStorage.getItem('welcomeShown')) {
                setTimeout(() => {
                    showNotification('üëã Para configurar el sistema, haz click en el candado üîí', 'info');
                    sessionStorage.setItem('welcomeShown', 'true');
                }, 1000);
            }
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchProducts(e.target.value);
            });
            
            // Color picker sync
            document.getElementById('primaryColor').addEventListener('change', function() {
                document.getElementById('primaryColorHex').value = this.value;
            });
            
            // Initialize notification preferences
            if (appData.settings.notifications) {
                document.getElementById('notificationSound').checked = appData.settings.notifications.sound !== false;
                document.getElementById('browserNotifications').checked = appData.settings.notifications.browser === true;
            }
            
            // Save notification preferences on change
            document.getElementById('notificationSound').addEventListener('change', function() {
                if (!appData.settings.notifications) {
                    appData.settings.notifications = {};
                }
                appData.settings.notifications.sound = this.checked;
                saveData();
            });
            
            // Close notification dropdown when clicking outside
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('notificationDropdown');
                const button = e.target.closest('#notificationBtn');
                if (!dropdown.contains(e.target) && !button) {
                    dropdown.classList.remove('show');
                }
            });
            
            // Set lock title
            document.getElementById('adminLock').title = 'Click para iniciar sesi√≥n';
        });

        // WhatsApp Message Parser Functions
        function parseWhatsAppMessage() {
            const message = document.getElementById('whatsappMessageInput').value.trim();
            
            if (!message) {
                showProcessStatus('Por favor pega un mensaje de WhatsApp', 'warning');
                return;
            }
            
            try {
                // Parse the WhatsApp message
                const data = extractWhatsAppData(message);
                
                if (!data) {
                    showProcessStatus('No se pudo interpretar el mensaje. Verifica el formato.', 'error');
                    return;
                }
                
                // Store parsed data
                parsedWhatsAppData = data;
                
                // Display parsed data
                displayParsedData(data);
                
                showProcessStatus('Mensaje analizado correctamente. Revisa los datos y confirma el procesamiento.', 'success');
                
            } catch (error) {
                console.error('Error parsing WhatsApp message:', error);
                showProcessStatus('Error al procesar el mensaje: ' + error.message, 'error');
            }
        }

        function extractWhatsAppData(message) {
            const data = {
                client: {},
                products: [],
                subtotal: 0,
                tax: 0,
                total: 0
            };
            
            // Clean the message
            const lines = message.split('\n').map(line => line.trim());
            
            // Extract client name
            const clientLine = lines.find(line => line.toLowerCase().includes('cliente:'));
            if (clientLine) {
                data.client.name = clientLine.split(':')[1].trim();
            }
            
            // Extract phone
            const phoneLine = lines.find(line => line.toLowerCase().includes('tel√©fono:') || line.toLowerCase().includes('telefono:'));
            if (phoneLine) {
                data.client.phone = phoneLine.split(':')[1].trim().replace(/\D/g, '');
            }
            
            // Extract address if present
            const addressLine = lines.find(line => line.toLowerCase().includes('direcci√≥n:') || line.toLowerCase().includes('direccion:'));
            if (addressLine) {
                data.client.address = addressLine.split(':')[1].trim();
            }
            
            // Extract products
            let inProductSection = false;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // Check if we're in the products section
                if (line.includes('Productos:') || line.includes('PRODUCTOS:')) {
                    inProductSection = true;
                    continue;
                }
                
                // Check if we've left the products section
                if (inProductSection && (line.includes('Subtotal:') || line.includes('SUBTOTAL:'))) {
                    inProductSection = false;
                }
                
                // Parse product lines
                if (inProductSection && line.startsWith('‚Ä¢')) {
                    const productData = parseProductLine(line);
                    if (productData) {
                        data.products.push(productData);
                    }
                }
            }
            
            // Extract totals
            const subtotalLine = lines.find(line => line.toLowerCase().includes('subtotal:'));
            if (subtotalLine) {
                data.subtotal = extractAmount(subtotalLine);
            }
            
            const taxLine = lines.find(line => line.toLowerCase().includes('iva'));
            if (taxLine) {
                data.tax = extractAmount(taxLine);
            }
            
            const totalLine = lines.find(line => line.toLowerCase().includes('total:'));
            if (totalLine) {
                // Get the last occurrence of TOTAL (in case there's subtotal and total)
                const totalLines = lines.filter(line => line.toLowerCase().includes('total:'));
                const finalTotalLine = totalLines[totalLines.length - 1];
                data.total = extractAmount(finalTotalLine);
            }
            
            // Validate data
            if (!data.client.name || !data.client.phone || data.products.length === 0) {
                throw new Error('Faltan datos importantes (cliente, tel√©fono o productos)');
            }
            
            return data;
        }

        function parseProductLine(line) {
            // Remove bullet point
            let productText = line.replace('‚Ä¢', '').trim();
            
            // Try to match pattern: Product xQuantity = Price
            const match = productText.match(/(.+?)\s*x\s*(\d+)\s*=\s*‚Ç°?([\d,]+)/);
            
            if (match) {
                return {
                    name: match[1].trim(),
                    quantity: parseInt(match[2]),
                    total: parseInt(match[3].replace(/,/g, ''))
                };
            }
            
            // Alternative pattern: Product (Quantity) - Price
            const altMatch = productText.match(/(.+?)\s*\((\d+)\)\s*[-‚Äì]\s*‚Ç°?([\d,]+)/);
            
            if (altMatch) {
                return {
                    name: altMatch[1].trim(),
                    quantity: parseInt(altMatch[2]),
                    total: parseInt(altMatch[3].replace(/,/g, ''))
                };
            }
            
            return null;
        }

        function extractAmount(line) {
            const match = line.match(/‚Ç°?([\d,]+)/);
            if (match) {
                return parseInt(match[1].replace(/,/g, ''));
            }
            return 0;
        }

        function displayParsedData(data) {
            const container = document.getElementById('parsedData');
            
            let html = `
                <h4 style="margin-bottom: 15px;">üìã Datos Detectados:</h4>
                
                <div class="parsed-item">
                    <span class="parsed-label">Cliente:</span>
                    <span class="parsed-value">${data.client.name}</span>
                </div>
                
                <div class="parsed-item">
                    <span class="parsed-label">Tel√©fono:</span>
                    <span class="parsed-value">${data.client.phone}</span>
                </div>
            `;
            
            if (data.client.address) {
                html += `
                    <div class="parsed-item">
                        <span class="parsed-label">Direcci√≥n:</span>
                        <span class="parsed-value">${data.client.address}</span>
                    </div>
                `;
            }
            
            html += `
                <h4 style="margin: 15px 0;">üì¶ Productos:</h4>
                <div class="parsed-products">
            `;
            
            data.products.forEach(product => {
                const existingProduct = findProductByName(product.name);
                const matchStatus = existingProduct ? 
                    '<span class="product-match found">‚úì Encontrado</span>' : 
                    '<span class="product-match not-found">‚ö† No encontrado</span>';
                
                html += `
                    <div class="parsed-product-item">
                        <span>${product.name} x${product.quantity} ${matchStatus}</span>
                        <span>‚Ç°${product.total.toLocaleString()}</span>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="parsed-item">
                    <span class="parsed-label">Subtotal:</span>
                    <span class="parsed-value">‚Ç°${data.subtotal.toLocaleString()}</span>
                </div>
                
                <div class="parsed-item">
                    <span class="parsed-label">IVA (13%):</span>
                    <span class="parsed-value">‚Ç°${data.tax.toLocaleString()}</span>
                </div>
                
                <div class="parsed-item" style="font-size: 18px; font-weight: bold; color: var(--primary);">
                    <span class="parsed-label">TOTAL:</span>
                    <span class="parsed-value">‚Ç°${data.total.toLocaleString()}</span>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn-primary btn-success" onclick="confirmWhatsAppProcess()">
                        ‚úÖ Confirmar y Procesar
                    </button>
                    <button class="btn-primary btn-warning" onclick="editParsedData()">
                        ‚úèÔ∏è Editar Datos
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
            container.classList.add('show');
        }

        function findProductByName(name) {
            // Clean and normalize the name for comparison
            const cleanName = name.toLowerCase().trim();
            
            return appData.products.find(product => {
                const productName = product.name.toLowerCase().trim();
                // Exact match or partial match
                return productName === cleanName || 
                       productName.includes(cleanName) || 
                       cleanName.includes(productName);
            });
        }

        function confirmWhatsAppProcess() {
            if (!parsedWhatsAppData) {
                showProcessStatus('No hay datos para procesar', 'error');
                return;
            }
            
            try {
                // Create sale record
                const sale = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    client: parsedWhatsAppData.client,
                    items: [],
                    subtotal: parsedWhatsAppData.subtotal,
                    tax: parsedWhatsAppData.tax,
                    total: parsedWhatsAppData.total,
                    status: 'Pendiente',
                    source: 'WhatsApp Manual'
                };
                
                // Process each product
                let allProductsFound = true;
                parsedWhatsAppData.products.forEach(item => {
                    const product = findProductByName(item.name);
                    
                    if (product) {
                        // Update inventory
                        if (product.stock >= item.quantity) {
                            product.stock -= item.quantity;
                        } else {
                            showNotification(`‚ö†Ô∏è Stock insuficiente para ${product.name}`, 'warning');
                        }
                        
                        // Add to sale items
                        sale.items.push({
                            name: product.name,
                            price: Math.round(item.total / item.quantity),
                            quantity: item.quantity,
                            total: item.total
                        });
                    } else {
                        // Product not found, create a temporary entry
                        allProductsFound = false;
                        sale.items.push({
                            name: item.name,
                            price: Math.round(item.total / item.quantity),
                            quantity: item.quantity,
                            total: item.total,
                            notFound: true
                        });
                    }
                });
                
                // Save sale
                appData.sales.push(sale);
                
                // Update or create client
                let client = appData.clients.find(c => c.phone === parsedWhatsAppData.client.phone);
                if (client) {
                    client.purchases++;
                    client.totalSpent += sale.total;
                    if (parsedWhatsAppData.client.address && !client.address) {
                        client.address = parsedWhatsAppData.client.address;
                    }
                } else {
                    appData.clients.push({
                        name: parsedWhatsAppData.client.name,
                        phone: parsedWhatsAppData.client.phone,
                        address: parsedWhatsAppData.client.address || '',
                        purchases: 1,
                        totalSpent: sale.total
                    });
                }
                
                // Create notification
                createPurchaseNotification({
                    clientName: parsedWhatsAppData.client.name,
                    clientPhone: parsedWhatsAppData.client.phone,
                    items: parsedWhatsAppData.products.length,
                    total: sale.total,
                    saleId: sale.id,
                    source: 'WhatsApp Manual'
                });
                
                // Save all changes
                saveData();
                
                // Update UI
                loadProducts();
                loadSales();
                loadClients();
                loadInventory();
                updateDashboard();
                
                // Clear processor
                clearWhatsAppProcessor();
                
                // Show success message
                if (allProductsFound) {
                    showNotification('‚úÖ Pedido procesado exitosamente', 'success');
                } else {
                    showNotification('‚ö†Ô∏è Pedido procesado. Algunos productos no se encontraron en el inventario.', 'warning');
                }
                
                // Show the sale
                showSection('sales', document.querySelector('.nav-tab:nth-child(3)'));
                
            } catch (error) {
                console.error('Error processing WhatsApp order:', error);
                showProcessStatus('Error al procesar el pedido: ' + error.message, 'error');
            }
        }

        function editParsedData() {
            // This would open a modal to edit the parsed data
            // For now, we'll just show a message
            showNotification('Funci√≥n de edici√≥n en desarrollo. Por ahora, corrige el mensaje y vuelve a analizarlo.', 'info');
        }

        function clearWhatsAppProcessor() {
            document.getElementById('whatsappMessageInput').value = '';
            document.getElementById('parsedData').innerHTML = '';
            document.getElementById('parsedData').classList.remove('show');
            document.getElementById('processStatus').style.display = 'none';
            parsedWhatsAppData = null;
        }

        function showProcessStatus(message, type) {
            const statusElement = document.getElementById('processStatus');
            statusElement.className = `process-status ${type}`;
            statusElement.innerHTML = message;
            statusElement.style.display = 'block';
            
            // Auto-hide after 5 seconds for non-error messages
            if (type !== 'error') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }

        function processWhatsAppFromModal() {
            const message = document.getElementById('modalWhatsappInput').value.trim();
            
            if (!message) {
                showNotification('Por favor pega un mensaje de WhatsApp', 'warning');
                return;
            }
            
            // Copy message to main processor
            document.getElementById('whatsappMessageInput').value = message;
            
            // Close modal
            closeModal('whatsappProcessModal');
            
            // Go to sales section
            showSection('sales', document.querySelector('.nav-tab:nth-child(3)'));
            
            // Process the message
            setTimeout(() => {
                parseWhatsAppMessage();
            }, 300);
        }

        // Data Management
        function loadData() {
            const saved = localStorage.getItem('pymeSystemData');
            if (saved) {
                appData = JSON.parse(saved);
                
                // Initialize notifications array if it doesn't exist
                if (!appData.notifications) {
                    appData.notifications = [];
                }
                
                // Initialize notification settings if they don't exist
                if (!appData.settings.notifications) {
                    appData.settings.notifications = {
                        sound: true,
                        browser: false
                    };
                }
                
                // Apply saved colors
                if (appData.settings.colors) {
                    applyColors();
                }
                
                // Apply saved logo
                if (appData.settings.logo) {
                    updateLogo();
                }
            }
            
            // Update UI with settings
            document.getElementById('businessName').textContent = appData.settings.businessName;
            document.getElementById('settingsBusinessName').value = appData.settings.businessName;
            document.getElementById('settingsWhatsApp').value = appData.settings.whatsapp || '';
            document.getElementById('settingsEmail').value = appData.settings.email || '';
            
            if (appData.settings.logo) {
                document.getElementById('settingsLogoUrl').value = appData.settings.logo;
                document.getElementById('logoPreview').innerHTML = `<img src="${appData.settings.logo}" style="max-height: 100px; border-radius: 8px;">`;
                document.getElementById('removeLogoBtn').style.display = 'inline-block';
            }
            
            if (appData.settings.colors) {
                document.getElementById('primaryColor').value = appData.settings.colors.primary;
                document.getElementById('primaryColorHex').value = appData.settings.colors.primary;
                document.getElementById('bgColor1').value = appData.settings.colors.bgColor1;
                document.getElementById('bgColor2').value = appData.settings.colors.bgColor2;
            }
        }

        function saveData() {
            localStorage.setItem('pymeSystemData', JSON.stringify(appData));
        }

        function factoryReset() {
            const confirmMessage = '‚ö†Ô∏è REINICIO TOTAL DE F√ÅBRICA ‚ö†Ô∏è\n\n' +
                'Esto eliminar√° PERMANENTEMENTE:\n' +
                '‚Ä¢ Todos los productos\n' +
                '‚Ä¢ Todos los clientes\n' +
                '‚Ä¢ Todas las ventas\n' +
                '‚Ä¢ Todas las notificaciones\n' +
                '‚Ä¢ Toda la configuraci√≥n\n\n' +
                '¬øEst√°s COMPLETAMENTE SEGURO?\n\n' +
                'Escribe "REINICIAR" para confirmar:';
            
            const confirmation = prompt(confirmMessage);
            
            if (confirmation === 'REINICIAR') {
                // Clear everything
                localStorage.clear();
                
                alert('‚úÖ Sistema reiniciado completamente.\n\nAhora est√° listo para una nueva empresa.');
                
                location.reload();
            } else if (confirmation !== null) {
                alert('Reinicio cancelado. No se realizaron cambios.');
            }
        }

        // Logo Management
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.settings.logo = e.target.result;
                    document.getElementById('settingsLogoUrl').value = e.target.result;
                    document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" style="max-height: 100px; border-radius: 8px;">`;
                    document.getElementById('removeLogoBtn').style.display = 'inline-block';
                    updateLogo();
                    saveData();
                    showNotification('Logo cargado exitosamente', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        function updateLogo() {
            if (appData.settings.logo) {
                document.getElementById('businessLogo').src = appData.settings.logo;
                document.getElementById('businessLogo').style.display = 'block';
                document.getElementById('logoIcon').style.display = 'none';
            }
        }

        function removeLogo() {
            appData.settings.logo = '';
            document.getElementById('businessLogo').style.display = 'none';
            document.getElementById('logoIcon').style.display = 'inline';
            document.getElementById('settingsLogoUrl').value = '';
            document.getElementById('logoPreview').innerHTML = '';
            document.getElementById('removeLogoBtn').style.display = 'none';
            saveData();
            showNotification('Logo eliminado', 'info');
        }

        // Color Management
        function saveColors() {
            appData.settings.colors = {
                primary: document.getElementById('primaryColor').value,
                bgColor1: document.getElementById('bgColor1').value,
                bgColor2: document.getElementById('bgColor2').value
            };
            applyColors();
            saveData();
            showNotification('Colores aplicados exitosamente', 'success');
        }

        function applyColors() {
            const root = document.documentElement;
            root.style.setProperty('--primary', appData.settings.colors.primary);
            root.style.setProperty('--gradient-1', `linear-gradient(135deg, ${appData.settings.colors.bgColor1} 0%, ${appData.settings.colors.bgColor2} 100%)`);
            document.body.style.background = `linear-gradient(135deg, ${appData.settings.colors.bgColor1} 0%, ${appData.settings.colors.bgColor2} 100%)`;
        }

        function resetColors() {
            appData.settings.colors = {
                primary: '#2563eb',
                bgColor1: '#667eea',
                bgColor2: '#764ba2'
            };
            document.getElementById('primaryColor').value = '#2563eb';
            document.getElementById('primaryColorHex').value = '#2563eb';
            document.getElementById('bgColor1').value = '#667eea';
            document.getElementById('bgColor2').value = '#764ba2';
            applyColors();
            saveData();
            showNotification('Colores restaurados', 'info');
        }

        function updateColorFromHex(type) {
            const hex = document.getElementById('primaryColorHex').value;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                document.getElementById('primaryColor').value = hex;
            }
        }

        // Admin Access
        function showAdminLogin() {
            if (isAdmin) {
                // If already admin, clicking the lock will logout
                logout();
            } else {
                // If not admin, show login modal
                showModal('adminModal');
                document.getElementById('adminPassword').focus();
            }
        }

        function login() {
            const password = document.getElementById('adminPassword').value;
            if (password === appData.settings.password) {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminLock').classList.add('unlocked');
                document.getElementById('adminLock').innerHTML = 'üîì';
                document.getElementById('adminLock').title = 'Click para cerrar sesi√≥n';
                closeModal('adminModal');
                
                // Show admin buttons
                document.getElementById('notificationBtn').style.display = 'inline-block';
                document.getElementById('addProductBtn').style.display = 'inline-block';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                
                // Initialize notifications system
                if (!appData.notifications) {
                    appData.notifications = [];
                }
                
                updateDashboard();
                updateNotificationBadge();
                initializeChatbot();
                showNotification('‚úÖ Modo administrador activado', 'success');
                document.getElementById('adminPassword').value = '';
                
                // Check for pending notifications
                if (appData.notifications && appData.notifications.length > 0) {
                    const unreadCount = appData.notifications.filter(n => !n.read).length;
                    if (unreadCount > 0) {
                        showNotification(`üì¨ Tienes ${unreadCount} notificaci√≥n(es) sin leer`, 'info');
                    }
                }
            } else {
                showNotification('‚ùå Contrase√±a incorrecta', 'error');
            }
        }

        function logout() {
            if (confirm('¬øDeseas cerrar la sesi√≥n de administrador?')) {
                isAdmin = false;
                document.body.classList.remove('admin-mode');
                document.getElementById('adminLock').classList.remove('unlocked');
                document.getElementById('adminLock').innerHTML = 'üîí';
                document.getElementById('adminLock').title = 'Click para iniciar sesi√≥n';
                
                // Hide admin buttons
                document.getElementById('notificationBtn').style.display = 'none';
                document.getElementById('addProductBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
                
                // Hide notification dropdown if open
                document.getElementById('notificationDropdown').classList.remove('show');
                
                showSection('catalog', document.querySelector('.nav-tab'));
                initializeChatbot();
                showNotification('üëã Sesi√≥n cerrada', 'info');
            }
        }

        // Navigation
        function showSection(sectionName, tabElement) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionName).classList.add('active');
            
            if (tabElement) {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tabElement.classList.add('active');
            }
            
            // Update sections
            if (sectionName === 'dashboard') updateDashboard();
            if (sectionName === 'sales') loadSales();
            if (sectionName === 'clients') loadClients();
            if (sectionName === 'inventory') loadInventory();
            if (sectionName === 'chatbot') loadChatbotSettings();
        }

        // Notification System Functions
        function createPurchaseNotification(data) {
            const notification = {
                id: Date.now().toString(),
                type: 'purchase',
                title: data.source === 'WhatsApp Manual' ? 'üì± Pedido WhatsApp Procesado' : '¬°Nueva Compra!',
                content: `${data.clientName} (${data.clientPhone}) - ${data.items} producto(s) por ‚Ç°${data.total.toLocaleString()}`,
                clientName: data.clientName,
                clientPhone: data.clientPhone,
                total: data.total,
                saleId: data.saleId,
                timestamp: new Date().toISOString(),
                read: false,
                source: data.source || 'Sistema'
            };
            
            // Add to notifications array
            if (!appData.notifications) appData.notifications = [];
            appData.notifications.unshift(notification);
            
            // Limit to 50 notifications
            if (appData.notifications.length > 50) {
                appData.notifications = appData.notifications.slice(0, 50);
            }
            
            saveData();
            
            // Update UI
            if (isAdmin) {
                updateNotificationBadge();
                showPurchasePopup(data);
                playNotificationSound();
                sendBrowserNotification(data);
                refreshNotificationList();
            }
        }

        function toggleNotificationCenter() {
            const dropdown = document.getElementById('notificationDropdown');
            const isOpen = dropdown.classList.contains('show');
            
            if (!isOpen) {
                dropdown.classList.add('show');
                refreshNotificationList();
                markNotificationsAsRead();
            } else {
                dropdown.classList.remove('show');
            }
        }

        function refreshNotificationList() {
            const list = document.getElementById('notificationList');
            
            if (!appData.notifications || appData.notifications.length === 0) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <div style="font-size: 48px; margin-bottom: 10px;">üì≠</div>
                        <p>No hay notificaciones nuevas</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = appData.notifications.map(notif => {
                const time = new Date(notif.timestamp).toLocaleTimeString('es-CR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const date = new Date(notif.timestamp).toLocaleDateString('es-CR');
                const today = new Date().toDateString() === new Date(notif.timestamp).toDateString();
                
                const sourceIcon = notif.source === 'WhatsApp Manual' ? 'üì±' : 'üõí';
                
                return `
                    <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="viewNotificationDetails('${notif.id}')">
                        <div class="notification-item-header">
                            <span class="notification-item-title">${sourceIcon} ${notif.title}</span>
                            <span class="notification-item-time">${today ? time : date}</span>
                        </div>
                        <div class="notification-item-content">
                            ${notif.content}
                        </div>
                        <div class="notification-item-actions">
                            <button class="notification-action-btn primary" onclick="event.stopPropagation(); callClient('${notif.clientPhone}')">
                                üìû Llamar
                            </button>
                            <button class="notification-action-btn secondary" onclick="event.stopPropagation(); viewSale('${notif.saleId}')">
                                üëÅÔ∏è Ver Venta
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateNotificationBadge() {
            if (!isAdmin) return;
            
            const badge = document.getElementById('notificationCount');
            const unreadCount = appData.notifications ? 
                appData.notifications.filter(n => !n.read).length : 0;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function markNotificationsAsRead() {
            if (appData.notifications) {
                appData.notifications.forEach(n => n.read = true);
                saveData();
                updateNotificationBadge();
            }
        }

        function clearAllNotifications() {
            if (confirm('¬øEliminar todas las notificaciones?')) {
                appData.notifications = [];
                saveData();
                refreshNotificationList();
                updateNotificationBadge();
                showNotification('Notificaciones eliminadas', 'info');
            }
        }

        function showPurchasePopup(data) {
            const popup = document.getElementById('purchasePopup');
            const details = document.getElementById('purchaseDetails');
            
            const sourceText = data.source === 'WhatsApp Manual' ? 
                '<span style="background: var(--whatsapp); color: white; padding: 2px 8px; border-radius: 5px; font-size: 11px;">WhatsApp</span>' : '';
            
            details.innerHTML = `
                <p><strong>${data.clientName}</strong> ${sourceText}</p>
                <p>üì± ${data.clientPhone}</p>
                <p>üõçÔ∏è ${data.items} producto(s)</p>
                <p style="font-size: 18px; color: var(--success); margin-top: 10px;">
                    <strong>Total: ‚Ç°${data.total.toLocaleString()}</strong>
                </p>
            `;
            
            popup.classList.add('show');
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                popup.classList.remove('show');
            }, 5000);
        }

        function closePurchasePopup() {
            document.getElementById('purchasePopup').classList.remove('show');
        }

        function playNotificationSound() {
            const soundEnabled = document.getElementById('notificationSound').checked;
            if (soundEnabled && appData.settings.notifications.sound !== false) {
                // Create a simple beep sound
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            }
        }

        function sendBrowserNotification(data) {
            const browserEnabled = document.getElementById('browserNotifications').checked;
            
            if (browserEnabled && 'Notification' in window && Notification.permission === 'granted') {
                const icon = data.source === 'WhatsApp Manual' ? 'üì±' : 'üõçÔ∏è';
                const title = data.source === 'WhatsApp Manual' ? 
                    'üì± Pedido WhatsApp Procesado' : 
                    'üõçÔ∏è ¬°Nueva Compra Recibida!';
                
                const notification = new Notification(title, {
                    body: `${data.clientName} (${data.clientPhone})\nTotal: ‚Ç°${data.total.toLocaleString()}`,
                    icon: icon,
                    badge: icon,
                    tag: 'purchase-' + data.saleId,
                    requireInteraction: true
                });
                
                notification.onclick = function() {
                    window.focus();
                    viewSale(data.saleId);
                    notification.close();
                };
                
                // Auto-close after 10 seconds
                setTimeout(() => notification.close(), 10000);
            }
        }

        function toggleBrowserNotifications() {
            const checkbox = document.getElementById('browserNotifications');
            
            if (checkbox.checked) {
                requestNotificationPermission();
            }
            
            // Save preference
            if (!appData.settings.notifications) {
                appData.settings.notifications = {};
            }
            appData.settings.notifications.browser = checkbox.checked;
            appData.settings.notifications.sound = document.getElementById('notificationSound').checked;
            
            saveData();
        }

        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('Notificaciones del navegador activadas', 'success');
                    } else {
                        document.getElementById('browserNotifications').checked = false;
                        showNotification('Permiso de notificaciones denegado', 'warning');
                    }
                });
            }
        }

        function callClient(phone) {
            window.location.href = `tel:${phone}`;
        }

        function viewSale(saleId) {
            const sale = appData.sales.find(s => s.id === saleId);
            if (sale) {
                showSection('sales');
                // Highlight the sale row
                setTimeout(() => {
                    const row = document.querySelector(`tr[data-sale-id="${saleId}"]`);
                    if (row) {
                        row.style.backgroundColor = 'var(--warning)';
                        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            row.style.backgroundColor = '';
                        }, 2000);
                    }
                }, 100);
            }
        }

        function viewNotificationDetails(notificationId) {
            const notification = appData.notifications.find(n => n.id === notificationId);
            if (notification && notification.saleId) {
                viewSale(notification.saleId);
                toggleNotificationCenter();
            }
        }

        // Products Management
        function loadProducts() {
            const grid = document.getElementById('productsGrid');
            let products = appData.products;
            
            if (currentFilter !== 'all') {
                products = products.filter(p => p.category === currentFilter);
            }
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üì¶</div><p>No hay productos</p>' + 
                    (isAdmin ? '<p style="margin-top: 10px;">Agrega productos con el bot√≥n "‚ûï Producto"</p>' : '') + '</div>';
                return;
            }
            
            grid.innerHTML = products.map(product => {
                const stockClass = product.stock === 0 ? 'out' : product.stock <= 5 ? 'low' : '';
                const stockText = product.stock === 0 ? 'Agotado' : `Stock: ${product.stock}`;
                const hasImage = product.image && product.image !== '';
                const imageStyle = hasImage ? `style="background-image: url('${product.image}');"` : '';
                const imageClass = hasImage ? 'has-image' : '';
                const icon = getCategoryIcon(product.category);
                
                return `
                    <div class="product-card">
                        <div class="product-image ${imageClass}" ${imageStyle}>
                            ${!hasImage ? icon : ''}
                        </div>
                        <div class="product-info">
                            <div class="product-category">${product.category}</div>
                            <div class="product-name">${product.name}</div>
                            <div class="product-description">${product.description || ''}</div>
                            <div class="product-price">‚Ç°${product.price.toLocaleString()}</div>
                            <div class="product-stock ${stockClass}">${stockText}</div>
                            <div class="product-actions">
                                <button class="btn-add-cart" onclick="addToCart('${product.id}')" ${product.stock === 0 ? 'disabled' : ''}>
                                    ${product.stock > 0 ? '‚ûï Agregar' : '‚ùå Sin Stock'}
                                </button>
                                ${isAdmin ? `
                                    <button class="btn-edit" onclick="editProduct('${product.id}')">‚úèÔ∏è</button>
                                    <button class="btn-delete" onclick="deleteProduct('${product.id}')">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCategoryIcon(category) {
            const icons = {
                'Alimentos': 'üçï',
                'Bebidas': '‚òï',
                'Tecnolog√≠a': 'üíª',
                'Hogar': 'üè†',
                'Ropa': 'üëï',
                'Salud': 'üíä',
                'Otros': 'üì¶'
            };
            return icons[category] || 'üì¶';
        }

        function saveProduct(event) {
            event.preventDefault();
            
            const productData = {
                id: document.getElementById('productId').value || Date.now().toString(),
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                price: parseInt(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                image: document.getElementById('productImageUrl').value || ''
            };
            
            if (editingProductId) {
                const index = appData.products.findIndex(p => p.id === editingProductId);
                appData.products[index] = productData;
                editingProductId = null;
                showNotification('Producto actualizado', 'success');
            } else {
                appData.products.push(productData);
                showNotification('Producto agregado', 'success');
            }
            
            saveData();
            loadProducts();
            loadInventory();
            closeModal('productModal');
            
            // Reset form
            event.target.reset();
            document.getElementById('imagePreview').classList.remove('show');
        }

        function editProduct(id) {
            const product = appData.products.find(p => p.id === id);
            if (!product) return;
            
            editingProductId = id;
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCategory').value = product.category;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productStock').value = product.stock;
            document.getElementById('productImageUrl').value = product.image || '';
            
            if (product.image) {
                document.getElementById('imagePreview').src = product.image;
                document.getElementById('imagePreview').classList.add('show');
            }
            
            document.getElementById('productModalTitle').textContent = 'Editar Producto';
            showModal('productModal');
        }

        function deleteProduct(id) {
            if (confirm('¬øEliminar este producto?')) {
                appData.products = appData.products.filter(p => p.id !== id);
                saveData();
                loadProducts();
                loadInventory();
                showNotification('Producto eliminado', 'warning');
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('productImageUrl').value = e.target.result;
                    document.getElementById('imagePreview').src = e.target.result;
                    document.getElementById('imagePreview').classList.add('show');
                };
                reader.readAsDataURL(file);
            }
        }

        // Cart Functions
        function addToCart(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;
            
            const cartItem = appData.cart.find(item => item.id === productId);
            if (cartItem) {
                if (cartItem.quantity < product.stock) {
                    cartItem.quantity++;
                } else {
                    showNotification('No hay m√°s stock disponible', 'warning');
                    return;
                }
            } else {
                appData.cart.push({ ...product, quantity: 1 });
            }
            
            updateCartBadge();
            saveData();
            showNotification('Agregado al carrito', 'success');
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const count = appData.cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = count;
            badge.classList.toggle('show', count > 0);
        }

        function openCart() {
            showModal('cartModal');
            renderCart();
        }

        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const clientForm = document.getElementById('clientForm');
            
            if (appData.cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üõí</div><p>Tu carrito est√° vac√≠o</p></div>';
                cartTotal.style.display = 'none';
                clientForm.style.display = 'none';
                return;
            }
            
            cartItems.innerHTML = appData.cart.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">‚Ç°${item.price.toLocaleString()} x ${item.quantity} = ‚Ç°${(item.price * item.quantity).toLocaleString()}</div>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="changeQuantity('${item.id}', -1)" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
                        <span class="quantity-display">${item.quantity}</span>
                        <button class="quantity-btn" onclick="changeQuantity('${item.id}', 1)" ${item.quantity >= item.stock ? 'disabled' : ''}>+</button>
                        <button class="btn-remove" onclick="removeFromCart('${item.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            updateCartTotals();
            cartTotal.style.display = 'block';
            clientForm.style.display = 'block';
        }

        function changeQuantity(productId, change) {
            const cartItem = appData.cart.find(item => item.id === productId);
            const product = appData.products.find(p => p.id === productId);
            
            if (!cartItem || !product) return;
            
            const newQuantity = cartItem.quantity + change;
            if (newQuantity > 0 && newQuantity <= product.stock) {
                cartItem.quantity = newQuantity;
                saveData();
                renderCart();
                updateCartBadge();
            }
        }

        function removeFromCart(productId) {
            appData.cart = appData.cart.filter(item => item.id !== productId);
            saveData();
            renderCart();
            updateCartBadge();
            showNotification('Producto eliminado del carrito', 'info');
        }

        function updateCartTotals() {
            const subtotal = appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const tax = Math.round(subtotal * 0.13);
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = '‚Ç°' + subtotal.toLocaleString();
            document.getElementById('tax').textContent = '‚Ç°' + tax.toLocaleString();
            document.getElementById('total').textContent = '‚Ç°' + total.toLocaleString();
        }

        function sendWhatsApp() {
            const name = document.getElementById('clientName').value.trim();
            const phone = document.getElementById('clientPhone').value.trim();
            
            if (!name || !phone) {
                document.getElementById('nameError').style.display = name ? 'none' : 'block';
                document.getElementById('phoneError').style.display = phone ? 'none' : 'block';
                showNotification('Por favor complete los campos requeridos', 'error');
                return;
            }
            
            const address = document.getElementById('clientAddress').value.trim();
            const notes = document.getElementById('clientNotes').value.trim();
            
            // Create sale record
            const sale = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                client: { name, phone, address },
                items: appData.cart.map(item => ({
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    total: item.price * item.quantity
                })),
                subtotal: appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                tax: Math.round(appData.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0) * 0.13),
                total: 0,
                status: 'Pendiente'
            };
            sale.total = sale.subtotal + sale.tax;
            
            // Save sale
            appData.sales.push(sale);
            
            // Update or create client
            let client = appData.clients.find(c => c.phone === phone);
            if (client) {
                client.purchases++;
                client.totalSpent += sale.total;
                if (address && !client.address) client.address = address;
            } else {
                appData.clients.push({
                    name,
                    phone,
                    address,
                    purchases: 1,
                    totalSpent: sale.total
                });
            }
            
            // Update inventory
            appData.cart.forEach(cartItem => {
                const product = appData.products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock -= cartItem.quantity;
                }
            });
            
            // Create notification for admin
            createPurchaseNotification({
                clientName: name,
                clientPhone: phone,
                items: appData.cart.length,
                total: sale.total,
                saleId: sale.id
            });
            
            // Format WhatsApp message
            let message = `üõçÔ∏è *NUEVO PEDIDO*\n\n`;
            message += `*Cliente:* ${name}\n`;
            message += `*Tel√©fono:* ${phone}\n`;
            if (address) message += `*Direcci√≥n:* ${address}\n`;
            message += `\nüì¶ *Productos:*\n`;
            
            appData.cart.forEach(item => {
                message += `‚Ä¢ ${item.name} x${item.quantity} = ‚Ç°${(item.price * item.quantity).toLocaleString()}\n`;
            });
            
            message += `\n*Subtotal:* ‚Ç°${sale.subtotal.toLocaleString()}\n`;
            message += `*IVA (13%):* ‚Ç°${sale.tax.toLocaleString()}\n`;
            message += `*TOTAL:* ‚Ç°${sale.total.toLocaleString()}\n`;
            
            if (notes) message += `\nüìù *Notas:* ${notes}`;
            
            // Send WhatsApp
            const whatsappUrl = `https://wa.me/${appData.settings.whatsapp}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Clear cart
            appData.cart = [];
            lastSaleData = sale;
            
            // Save all changes
            saveData();
            updateCartBadge();
            loadProducts();
            
            // Show success
            showNotification('Pedido enviado por WhatsApp', 'success');
            
            // Reset form
            document.getElementById('clientName').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
            document.getElementById('clientNotes').value = '';
            
            setTimeout(() => {
                closeModal('cartModal');
                renderCart();
            }, 2000);
        }

        // Other sections
        function updateDashboard() {
            const totalSales = appData.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalClients = appData.clients.length;
            const totalProducts = appData.products.length;
            const today = new Date().toDateString();
            const todayOrders = appData.sales.filter(s => new Date(s.date).toDateString() === today).length;
            
            document.getElementById('totalSales').textContent = '‚Ç°' + totalSales.toLocaleString();
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('todayOrders').textContent = todayOrders;
            
            // Recent sales
            const recentSales = appData.sales.slice(-5).reverse();
            const recentSalesTable = document.getElementById('recentSalesTable');
            
            if (recentSales.length > 0) {
                recentSalesTable.innerHTML = recentSales.map(sale => `
                    <tr>
                        <td>${new Date(sale.date).toLocaleDateString('es-CR')}</td>
                        <td>${sale.client.name}</td>
                        <td>‚Ç°${sale.total.toLocaleString()}</td>
                        <td><span style="background: ${sale.status === 'Completado' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 3px 8px; border-radius: 5px; font-size: 12px;">${sale.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        function loadSales() {
            const salesTable = document.getElementById('salesTable');
            
            if (appData.sales.length === 0) {
                salesTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay ventas</td></tr>';
                return;
            }
            
            salesTable.innerHTML = appData.sales.slice().reverse().map(sale => {
                const sourceIcon = sale.source === 'WhatsApp Manual' ? 'üì±' : 'üõí';
                return `
                    <tr data-sale-id="${sale.id}">
                        <td>${sourceIcon} #${sale.id.slice(-6)}</td>
                        <td>${new Date(sale.date).toLocaleDateString('es-CR')}</td>
                        <td>${sale.client.name}</td>
                        <td>‚Ç°${sale.total.toLocaleString()}</td>
                        <td><span style="background: ${sale.status === 'Completado' ? 'var(--success)' : 'var(--warning)'}; color: white; padding: 3px 8px; border-radius: 5px; font-size: 12px;">${sale.status}</span></td>
                        <td>
                            <button class="btn-primary btn-success" onclick="markAsComplete('${sale.id}')" style="padding: 5px 10px; font-size: 12px;" ${sale.status === 'Completado' ? 'disabled' : ''}>‚úì Completar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function markAsComplete(saleId) {
            const sale = appData.sales.find(s => s.id === saleId);
            if (sale) {
                sale.status = 'Completado';
                saveData();
                loadSales();
                showNotification('Venta marcada como completada', 'success');
            }
        }

        function loadClients() {
            const clientsTable = document.getElementById('clientsTable');
            
            if (appData.clients.length === 0) {
                clientsTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay clientes</td></tr>';
                return;
            }
            
            clientsTable.innerHTML = appData.clients.map(client => `
                <tr>
                    <td>${client.name}</td>
                    <td>${client.phone}</td>
                    <td>${client.address || '-'}</td>
                    <td>${client.purchases}</td>
                    <td>‚Ç°${client.totalSpent.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function loadInventory() {
            const inventoryTable = document.getElementById('inventoryTable');
            
            if (appData.products.length === 0) {
                inventoryTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay productos</td></tr>';
                return;
            }
            
            inventoryTable.innerHTML = appData.products.map(product => `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>
                        <span style="background: ${product.stock === 0 ? 'var(--danger)' : product.stock <= 5 ? 'var(--warning)' : 'var(--success)'}; color: white; padding: 3px 8px; border-radius: 5px;">
                            ${product.stock}
                        </span>
                    </td>
                    <td>‚Ç°${product.price.toLocaleString()}</td>
                    <td>
                        <button class="btn-primary" onclick="editProduct('${product.id}')" style="padding: 5px 10px; font-size: 12px;">‚úèÔ∏è Editar</button>
                        <button class="btn-primary btn-danger" onclick="deleteProduct('${product.id}')" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">üóëÔ∏è Eliminar</button>
                    </td>
                </tr>
            `).join('');
        }

        // Settings
        function saveSettings() {
            const newName = document.getElementById('settingsBusinessName').value;
            const newWhatsApp = document.getElementById('settingsWhatsApp').value;
            const newEmail = document.getElementById('settingsEmail').value;
            const newPassword = document.getElementById('settingsPassword').value;
            const newLogo = document.getElementById('settingsLogoUrl').value;
            
            appData.settings.businessName = newName || appData.settings.businessName;
            appData.settings.whatsapp = newWhatsApp || appData.settings.whatsapp;
            appData.settings.email = newEmail || appData.settings.email;
            
            if (newPassword) {
                appData.settings.password = newPassword;
                document.getElementById('settingsPassword').value = '';
            }
            
            if (newLogo && newLogo !== appData.settings.logo) {
                appData.settings.logo = newLogo;
                updateLogo();
            }
            
            document.getElementById('businessName').textContent = appData.settings.businessName;
            
            saveData();
            showNotification('Configuraci√≥n guardada', 'success');
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `backup_${appData.settings.businessName}_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Backup descargado', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('¬øImportar estos datos? Se reemplazar√°n todos los datos actuales.')) {
                            appData = importedData;
                            saveData();
                            location.reload();
                        }
                    } catch (error) {
                        showNotification('Error al importar archivo', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // Chatbot Functions
        function initializeChatbot() {
            if (!appData.chatbot) {
                appData.chatbot = {
                    enabled: true,
                    name: 'Asistente Virtual',
                    welcome: '¬°Hola! üëã Soy tu asistente virtual. ¬øEn qu√© puedo ayudarte hoy?',
                    faqs: [],
                    quickResponses: {
                        horario: 'Nuestro horario de atenci√≥n es de Lunes a Viernes.',
                        entrega: 'Los tiempos de entrega son de 24-48 horas.',
                        pago: 'Aceptamos: Efectivo, SINPE M√≥vil, Transferencia.',
                        contacto: ''
                    }
                };
            }
            
            // Update contact response
            appData.chatbot.quickResponses.contacto = `Puedes contactarnos por WhatsApp al ${appData.settings.whatsapp || 'n√∫mero no configurado'}`;
            
            // Update chatbot title
            document.getElementById('chatbotTitle').textContent = appData.chatbot.name || 'Asistente Virtual';
            
            // Show/hide widget
            const widget = document.getElementById('chatbotWidget');
            if (widget) {
                widget.style.display = (appData.chatbot.enabled && !isAdmin) ? 'block' : 'none';
            }
            
            // Show notification dot on first visit
            if (!sessionStorage.getItem('chatbotWelcomed') && !isAdmin && appData.chatbot.enabled) {
                setTimeout(() => {
                    const dot = document.querySelector('.notification-dot');
                    if (dot) dot.style.display = 'block';
                }, 3000);
            }
        }

        function toggleChatbot() {
            const window = document.getElementById('chatbotWindow');
            const isOpen = window.classList.contains('show');
            
            if (!isOpen) {
                window.classList.add('show');
                
                // Send welcome message if first time
                if (!sessionStorage.getItem('chatbotWelcomed')) {
                    const messages = document.getElementById('chatMessages');
                    messages.innerHTML = '';
                    addBotMessage(appData.chatbot.welcome);
                    sessionStorage.setItem('chatbotWelcomed', 'true');
                    
                    // Hide notification dot
                    const dot = document.querySelector('.notification-dot');
                    if (dot) dot.style.display = 'none';
                }
            } else {
                window.classList.remove('show');
            }
        }

        function addBotMessage(message) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message bot';
            messageDiv.innerHTML = `
                <div class="message-bubble">${message}</div>
                <div class="message-time">${new Date().toLocaleTimeString('es-CR', {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function addUserMessage(message) {
            const messages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user';
            messageDiv.innerHTML = `
                <div class="message-bubble">${message}</div>
                <div class="message-time">${new Date().toLocaleTimeString('es-CR', {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        function sendQuickMessage(type) {
            const responses = appData.chatbot.quickResponses;
            const messages = {
                'horario': '¬øCu√°l es su horario de atenci√≥n?',
                'entrega': '¬øCu√°les son los tiempos de entrega?',
                'pago': '¬øQu√© m√©todos de pago aceptan?',
                'contacto': '¬øC√≥mo puedo contactarlos?'
            };
            
            addUserMessage(messages[type]);
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                addBotMessage(responses[type]);
            }, 1000);
        }

        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                const response = processUserMessage(message);
                addBotMessage(response);
            }, 1500);
        }

        function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check FAQs
            if (appData.chatbot.faqs) {
                for (let faq of appData.chatbot.faqs) {
                    if (faq.question) {
                        const keywords = faq.question.toLowerCase().split(' ');
                        let matchCount = 0;
                        for (let keyword of keywords) {
                            if (keyword.length > 3 && lowerMessage.includes(keyword)) {
                                matchCount++;
                            }
                        }
                        if (matchCount >= 2) {
                            return faq.answer;
                        }
                    }
                }
            }
            
            // Check keywords
            if (lowerMessage.includes('precio') || lowerMessage.includes('costo')) {
                return 'Para conocer los precios, revisa nuestro cat√°logo de productos. Los precios est√°n actualizados en cada producto.';
            }
            
            if (lowerMessage.includes('pedido') || lowerMessage.includes('comprar')) {
                return 'Para realizar un pedido: 1) Agrega productos al carrito, 2) Completa tus datos, 3) Env√≠a el pedido por WhatsApp.';
            }
            
            // Default
            return `No tengo una respuesta espec√≠fica para eso. Contacta por WhatsApp al ${appData.settings.whatsapp || 'n√∫mero no configurado'} para m√°s informaci√≥n.`;
        }

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.classList.add('show');
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.classList.remove('show');
        }

        // Chatbot Admin Functions
        function loadChatbotSettings() {
            if (!appData.chatbot) initializeChatbot();
            
            document.getElementById('botName').value = appData.chatbot.name || '';
            document.getElementById('botWelcome').value = appData.chatbot.welcome || '';
            document.getElementById('botEnabled').checked = appData.chatbot.enabled;
            document.getElementById('botHours').value = appData.chatbot.quickResponses.horario || '';
            document.getElementById('botDelivery').value = appData.chatbot.quickResponses.entrega || '';
            document.getElementById('botPayment').value = appData.chatbot.quickResponses.pago || '';
            
            loadFAQList();
        }

        function saveChatbotSettings() {
            appData.chatbot.name = document.getElementById('botName').value || 'Asistente Virtual';
            appData.chatbot.welcome = document.getElementById('botWelcome').value || '¬°Hola! ¬øEn qu√© puedo ayudarte?';
            appData.chatbot.enabled = document.getElementById('botEnabled').checked;
            
            saveData();
            initializeChatbot();
            showNotification('Configuraci√≥n del chatbot guardada', 'success');
        }

        function saveQuickResponses() {
            appData.chatbot.quickResponses.horario = document.getElementById('botHours').value;
            appData.chatbot.quickResponses.entrega = document.getElementById('botDelivery').value;
            appData.chatbot.quickResponses.pago = document.getElementById('botPayment').value;
            
            saveData();
            showNotification('Respuestas r√°pidas guardadas', 'success');
        }

        function loadFAQList() {
            const container = document.getElementById('faqList');
            if (!container || !appData.chatbot.faqs) return;
            
            if (appData.chatbot.faqs.length === 0) {
                container.innerHTML = '<p style="color: #6b7280;">No hay preguntas frecuentes configuradas</p>';
                return;
            }
            
            container.innerHTML = appData.chatbot.faqs.map((faq, index) => `
                <div class="faq-item">
                    <input type="text" class="form-input" value="${faq.question || ''}" placeholder="Pregunta" onchange="updateFAQ(${index}, 'question', this.value)">
                    <textarea class="form-textarea" placeholder="Respuesta" onchange="updateFAQ(${index}, 'answer', this.value)">${faq.answer || ''}</textarea>
                    <button class="btn-primary btn-danger" onclick="deleteFAQ(${index})" style="padding: 5px 15px; font-size: 14px;">üóëÔ∏è Eliminar</button>
                </div>
            `).join('');
        }

        function addFAQ() {
            if (!appData.chatbot.faqs) appData.chatbot.faqs = [];
            appData.chatbot.faqs.push({ question: '', answer: '' });
            loadFAQList();
        }

        function updateFAQ(index, field, value) {
            appData.chatbot.faqs[index][field] = value;
            saveData();
        }

        function deleteFAQ(index) {
            if (confirm('¬øEliminar esta pregunta frecuente?')) {
                appData.chatbot.faqs.splice(index, 1);
                saveData();
                loadFAQList();
                showNotification('Pregunta eliminada', 'warning');
            }
        }

        // Utilities
        function filterCategory(category, btn) {
            currentFilter = category;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadProducts();
        }

        function searchProducts(term) {
            const cards = document.querySelectorAll('.product-card');
            const searchTerm = term.toLowerCase();
            
            cards.forEach(card => {
                const name = card.querySelector('.product-name').textContent.toLowerCase();
                const description = card.querySelector('.product-description').textContent.toLowerCase();
                const category = card.querySelector('.product-category').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || description.includes(searchTerm) || category.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s forwards';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }
    </script>
</body>
</html>